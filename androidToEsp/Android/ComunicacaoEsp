package com.example.robosmart.data.repository;

import android.os.AsyncTask;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.URL;

public class ComunicacaoEsp extends AsyncTask<Void, Void, String> {

    private String xRobo, yRobo, orientacaoRobo, goalX, goalY;
    private String[] obstaculosX, obstaculosY;

    public ComunicacaoEsp(String xRobo, String yRobo, String orientacaoRobo,
    String goalX, String goalY, String[] obstaculosX, String[] obstaculosY) {
        this.xRobo = xRobo;
        this.yRobo = yRobo;
        this.orientacaoRobo = orientacaoRobo;
        this.goalX = goalX;
        this.goalY = goalY;
        this.obstaculosX = obstaculosX;
        this.obstaculosY = obstaculosY;
    }

    @Override
    protected String doInBackground(Void... voids) {
        try {
            // URL do servidor ESP32
            URL url = new URL("http://IP DO ESP32/enviar-coord");

            // Abre a conexão
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("POST");
            connection.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");
            connection.setDoOutput(true);

            // Monta os dados a serem enviados
            StringBuilder postData = new StringBuilder();
            postData.append("RoboX=").append(xRobo)
                    .append("&RoboY=").append(yRobo)
                    .append("&RoboTheta=").append(orientacaoRobo)
                    .append("&goalX=").append(goalX)
                    .append("&goalY=").append(goalY);

            // Adiciona os obstáculos
            for (int i = 0; i < obstaculosX.length; i++) {
                postData.append("&obstaculo").append(i + 1).append("X=").append(obstaculosX[i])
                        .append("&obstaculo").append(i + 1).append("Y=").append(obstaculosY[i]);
            }
            //EXEMPLO DE ENVIO DE DADOS (RoboX=1&RoboY=2&RoboTheta=3&goalX=4&goalY=5&obstaculo1X=6&obstaculo1Y=7&obstaculo2X=8&obstaculo2Y=9)
            // Envia os dados
            OutputStream os = connection.getOutputStream();
            os.write(postData.toString().getBytes());
            os.flush();
            os.close();

            // Recebe a resposta do servidor
            int responseCode = connection.getResponseCode();
            if (responseCode == HttpURLConnection.HTTP_OK) {
                return "Dados enviados com sucesso!";
            } else {
                return "Erro ao enviar os dados. Código: " + responseCode;
            }

        } catch (Exception e) {
            e.printStackTrace();
            return "Erro: " + e.getMessage();
        }
    }

    @Override
    protected void onPostExecute(String result) {
        // Aqui você pode atualizar a interface do usuário com o resultado da requisição
        // Exemplo: Toast.makeText(context, result, Toast.LENGTH_SHORT).show();
    }
}
